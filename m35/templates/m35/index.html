<!-- templates/index.html -->
{% extends 'base.html' %}

{% load static %}

{% block title %}M35{% endblock %}

{% block extra_css %}
<link href="https://cdnjs.cloudflare.com/ajax/libs/flowbite/2.2.1/flowbite.min.css" rel="stylesheet" />
{% endblock %}

{% block extra_js %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/flowbite/2.2.1/flowbite.min.js"></script>
{% endblock %}

{% block content %}

    <style>
        /* Custom styles that can't be easily done with Tailwind */
        .gradient-blue {
            background: linear-gradient(to bottom, #4a90e2, #357abd);
        }
        
        .gradient-gray {
            background: linear-gradient(to bottom, #f8f8f8, #e8e8e8);
        }
        
        .gradient-light-gray {
            background: linear-gradient(to bottom, #f0f0f0, #e0e0e0);
        }

        /* Animation for messages */
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        .animate-slide-in {
            animation: slideIn 0.3s ease-out;
        }

        /* Custom task grid */
        .task-grid {
            display: grid;
            grid-template-columns: 25px 1fr 60px 50px 70px;
            gap: 3px;
            margin-bottom: 8px;
        }

        /* ใช้เฉพาะตารางที่มี id="dataTable" */
        #dataTable {
            counter-reset: rowNumber;
        }

        #dataTable .row-number::before {
            counter-increment: rowNumber;
            content: counter(rowNumber) ".";
        }

        /* ใช้เฉพาะตารางที่มี id="dataTable" */
        #dataTable1 {
            counter-reset: rowNumber;
        }

        #dataTable1 .row-number::before {
            counter-increment: rowNumber;
            content: counter(rowNumber) ".";
        }
    </style>

    <!-- Loading Indicator -->
    <div id="loading" class="fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-black bg-opacity-80 text-white p-5 rounded z-50 hidden">
        กำลังประมวลผล...
    </div>

    <!-- Messages -->
    <div id="messages" class="fixed top-12 right-5 z-40 max-w-xs"></div>

    <!-- CSRF Token -->
    {% csrf_token %}

    <!-- Title Bar -->
    <div class="gradient-blue text-white px-4 py-2 flex justify-center items-center relative font-bold text-sm">
        <span>ใบเสร็จรับเงิน</span>

    </div>
    <div class="flex bg-gray-100 font-thai overflow-hidden" style="height: calc(100vh - 80px);">
        
        <!-- Left Panel - Data Table (50% width) -->
        <div class="flex-1 bg-pink-100 flex flex-col text-center">
            
            <!-- Table Container -->
            <div class="flex-1 overflow-auto border border-gray-400 m-1 bg-white">
                <table class="w-full border-collapse">
                    <thead>
                        <tr>
                            <th class="gradient-light-gray border border-gray-600 px-2 py-1 font-bold sticky top-0 z-10 w-16">วันที่</th>
                            <th class="gradient-light-gray border border-gray-600 px-2 py-1 font-bold sticky top-0 z-10 w-16">ใบเสร็จ</th>
                            <th class="gradient-light-gray border border-gray-600 px-2 py-1 font-bold sticky top-0 z-10 w-16">ห้อง</th>
                            <th class="gradient-light-gray border border-gray-600 px-2 py-1 font-bold sticky top-0 z-10 w-32">ชื่อ</th>
                            <!-- <th class="gradient-light-gray border border-gray-600 px-2 py-1 font-bold sticky top-0 z-10 w-32">ลูกค้า</th> -->
                            <th class="gradient-light-gray border border-gray-600 px-2 py-1 font-bold sticky top-0 z-10 w-16">จำนวนเงิน</th>
                            <th class="gradient-light-gray border border-gray-600 px-2 py-1 font-bold sticky top-0 z-10 w-24">หมายเหตุ</th>
                        </tr>
                    </thead>
                    <tbody id="dataTable">
                        {% for record in data %}
                        <tr onclick="selectRecord(this, '{{ record.id }}')" data-id="{{ record.id }}" 
                            class="cursor-pointer hover:bg-blue-100 even:bg-gray-50 border-b border-gray-200">
                            <td class="border border-gray-300 px-2 py-1 whitespace-nowrap">{{ record.date|date:"d/m/Y" }}</td>
                            <td class="border border-gray-300 px-2 py-1 whitespace-nowrap">{{ record.r_c_no}}</td>
                            <td class="border border-gray-300 px-2 py-1 whitespace-nowrap">{{ record.room_no_1 }}</td>
                            <td class="border border-gray-300 px-2 py-1 whitespace-nowrap">{{ record.member_2 }}</td>
                            <td class="border border-gray-300 px-2 py-1 whitespace-nowrap"></td>
                            <td class="border border-gray-300 px-2 py-1 text-center whitespace-nowrap">{{ record.remark_1|default:"-" }}</td>                 
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="7" class="border border-gray-300 text-center py-5 text-gray-600">
                                ไม่พบข้อมูลใบเสร็จ
                                {% if search_query %}
                                    สำหรับคำค้นหา "{{ search_query }}"
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <!-- Navigation Buttons -->
            <div class="bg-pink-100 px-2 py-1 flex gap-1 items-center">
                {% if page_obj.has_previous %}
                    <a href="?page=1{% if search_query %}&search={{ search_query }}{% endif %}{% if date_from %}&date_from={{ date_from }}{% endif %}{% if date_to %}&date_to={{ date_to }}{% endif %}" 
                        class="w-6 h-5 gradient-gray border border-gray-600 cursor-pointer flex items-center justify-center text-black no-underline hover:bg-gray-300">|&lt;</a>
                    <a href="?page={{ page_obj.previous_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}{% if date_from %}&date_from={{ date_from }}{% endif %}{% if date_to %}&date_to={{ date_to }}{% endif %}" 
                        class="w-6 h-5 gradient-gray border border-gray-600 cursor-pointer flex items-center justify-center text-black no-underline hover:bg-gray-300">&lt;</a>
                {% else %}
                    <span class="w-6 h-5 gradient-gray border border-gray-600 flex items-center justify-center text-black opacity-50 cursor-not-allowed">|&lt;</span>
                    <span class="w-6 h-5 gradient-gray border border-gray-600 flex items-center justify-center text-black opacity-50 cursor-not-allowed">&lt;</span>
                {% endif %}
                
                {% if page_obj.has_next %}
                    <a href="?page={{ page_obj.next_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}{% if date_from %}&date_from={{ date_from }}{% endif %}{% if date_to %}&date_to={{ date_to }}{% endif %}" 
                        class="w-6 h-5 gradient-gray border border-gray-600 cursor-pointer flex items-center justify-center text-black no-underline hover:bg-gray-300">&gt;</a>
                    <a href="?page={{ page_obj.paginator.num_pages }}{% if search_query %}&search={{ search_query }}{% endif %}{% if date_from %}&date_from={{ date_from }}{% endif %}{% if date_to %}&date_to={{ date_to }}{% endif %}" 
                        class="w-6 h-5 gradient-gray border border-gray-600 cursor-pointer flex items-center justify-center text-black no-underline hover:bg-gray-300">&gt;|</a>
                {% else %}
                    <span class="w-6 h-5 gradient-gray border border-gray-600 flex items-center justify-center text-black opacity-50 cursor-not-allowed">&gt;</span>
                    <span class="w-6 h-5 gradient-gray border border-gray-600 flex items-center justify-center text-black opacity-50 cursor-not-allowed">&gt;|</span>
                {% endif %}
                <div class="hotkey-hint flex items-center text-sm text-gray-600 ml-2">
                    <div class="ml-2 text-gray-600">
                        หน้า 1 / 3 (1-3 จาก 25) | 
                    </div>
                    <button type="button" class="w-16 gradient-gray border border-gray-600 py-0.5 cursor-pointer hover:bg-gray-300 ml-2 rounded text-green-600" 
                     onclick="new_Record()">F2 เพิ่ม</button>
                    <button type="button" class="w-20 gradient-gray border border-gray-600 py-0.5 cursor-pointer hover:bg-gray-300 ml-2 rounded text-orange-600" 
                     onclick="saveRecord()">F10 บันทึก</button>
                    <button type="button" class="w-16 gradient-gray border border-gray-600 py-0.5 cursor-pointer hover:bg-gray-300 ml-2 rounded text-blue-900" 
                     onclick="editRecord()">F3 แก้ไข</button>
                     <button type="button" class="w-16 gradient-gray border border-gray-600 py-0.5 cursor-pointer hover:bg-gray-300 ml-2 rounded text-red-600" 
                     onclick="deleteRecord()">F4 ลบ</button>
                    <button type="button" class="w-16 gradient-gray border border-gray-600 py-0.5 cursor-pointer hover:bg-gray-300 ml-2 rounded text-purple-600" 
                     onclick="">F5 ค้นหา</button>
                    <button type="button" class="w-16 gradient-gray border border-gray-600 py-0.5 cursor-pointer hover:bg-gray-300 ml-2 rounded text-blue-600" 
                     onclick="">F6 พิมพ์</button>
                    <button type="button" class="w-16 gradient-gray border border-gray-600 py-0.5 cursor-pointer hover:bg-gray-300 ml-2 rounded text-yellow-500" 
                     onclick="cancelEdit()">ESC ออก</button>
                </div>
            </div>
            
        </div>

        <!-- Right Panel (50% width) -->
        <div class="flex-1 bg-pink-100 flex flex-col">
            <!-- Form Section -->
            <form method="POST" action="" id="formSection" class="bg-pink-100 mb-1">
                {% csrf_token %}
                <div class="ml-10 py-4">
                    <div class="flex items-center gap-1 mb-0.5">
                        
                        <div class="flex items-center gap-1">
                            <label class="w-28 flex-shrink-0">เลขที่ใบเสร็จ</label>
                            <input type="text" name="r_c_no" class="w-24 px-1 py-0.5 border border-gray-600 bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500" id="r_c_no">
                        </div>
                    
                        <div class="flex items-center gap-1">
                            <label class="flex-shrink-0 ml-6 mr-4">วันที่</label>
                            <input type="date" name="date" class="w-32 px-1 py-0.5 border border-gray-600 bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500" id="date">

                        </div>

                        <div class="flex items-center gap-1">
                            <label class="flex-shrink-0 ml-6 mr-4">ฝาก</label>
                            <input type="date" name="payin" class="w-32 px-1 py-0.5 border border-gray-600 bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500" id="payin">

                            <!-- <button type="button" class="w-24 gradient-gray border border-gray-600 py-0.5 cursor-pointer hover:bg-gray-300 ml-16" onclick="printReport()">REPORT</button> -->
                        </div>
                        
                    </div>
                    
                    <div class="flex items-center gap-1 mb-0.5">
                       
                            <div class="flex items-center gap-1">
                                <label class="w-28 flex-shrink-0 px-4">เลขที่ห้อง</label>
                                <input type="text" name="room_no1" class="w-24 px-1 py-0.5 border border-gray-600 bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500" id="room_no_1">
                                <input type="text" name="room_no2" class="w-72 px-1 py-0.5 border border-gray-600 bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500" id="room_no_2">
                            </div>
                        
                    </div>
                    
                    
                    
                    <div class="flex items-center gap-1 mb-0.5">
                        <div class="flex-1">
                            <div class="flex items-center gap-1">
                                <label class="w-28 flex-shrink-0 px-7">รหัส-ชื่อ</label>
                                <input type="text" name="member_1" class="w-24 px-1 py-0.5 border border-gray-600 bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500" id="member_1">
                                <input type="text" name="member_2" class="w-96 px-1 py-0.5 border border-gray-600 bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500" id="member_2">
                            </div>
                        </div>
                        
                    </div>
                    
                    <div class="flex-1">
                        <div class="flex items-center gap-1 mt-2">
                            <label class="w-28 flex-shrink-0 px-7">ประเภท</label>
                            {% for value,label in type_choices %}
                            <input type="radio" id="type_{{ forloop.counter }}" name="type" value="{{value}}" class="accent-blue-600">
                            <label class="mr-3" for="type_{{ forloop.counter }}">{{label}}</label>
                            {% endfor %}

                            <!-- <input type="radio" id="option2" name="payment" value="จ่ายล่วงหน้า" class="accent-blue-600 ml-5">
                            <label for="option2">จ่ายล่วงหน้า</label>

                            <input type="radio" id="option3" name="payment" value="รายรับอื่นๆ" class="accent-blue-600 ml-5">
                            <label for="option3">รายรับอื่นๆ</label> -->

                            <button id="btnUnpaid" type="button" class="w-24 gradient-gray border border-gray-600 py-0.5 cursor-pointer hover:bg-gray-300 ml-10 rounded" data-modal-toggle="unpaidModal" data-modal-target="unpaidModal" onclick="getModal()">บิลค้างชำระ</button>
                            

                        </div>
                    </div>
                    
                    
                    <input type="hidden" name="currentRecordId" id="currentRecordId" value="">
                    <input type="hidden" name="formMode" id="formMode" value="view">
                </div>

                <!-- Task List -->
                <div class="bg-pink-100 flex-1 flex flex-col mb-1">
                    <div class="bg-white flex-1 overflow-auto border border-gray-400 mx-2">
                        <table class="w-full border-collapse table-fixed">
                            <thead>
                                <tr>
                                    <th class="gradient-light-gray border border-gray-600 py-1 font-bold sticky top-0 z-10 w-4">ลำดับ</th>
                                    <th class="gradient-light-gray border border-gray-600 px-2 py-1 font-bold sticky top-0 z-10 w-7">รหัส</th>
                                    <th class="gradient-light-gray border border-gray-600 px-2 py-1 font-bold sticky top-0 z-10 w-32">รายการ</th>
                                    <th class="gradient-light-gray border border-gray-600 px-2 py-1 font-bold sticky top-0 z-10 w-10">อัตรา-F12</th>
                                    <th class="gradient-light-gray border border-gray-600 px-2 py-1 font-bold sticky top-0 z-10 w-10">จำนวน</th>
                                    <th class="gradient-light-gray border border-gray-600 px-2 py-1 font-bold sticky top-0 z-10 w-14">เป็นเงิน</th>
                                </tr>
                            </thead>
                            <tbody id="dataTable1">
                               
                                {% for i in row_numbers %}
                                <tr onclick="" 
                                    class="cursor-pointer hover:bg-blue-100 even:bg-gray-50 border-b border-gray-200">
                                    <td class="border border-gray-300 py-1 text-center row-number"></td>
                                    <td class="border border-gray-300 px-2 py-1 whitespace-nowrap"></td>
                                    <td class="border border-gray-300 px-2 py-1 whitespace-nowrap"></td>
                                    <td class="border border-gray-300 px-2 py-1 whitespace-nowrap"></td>
                                    <td class="border border-gray-300 px-2 py-1 whitespace-nowrap"></td>
                                    <td class="border border-gray-300 px-2 py-1 text-center whitespace-nowrap"></td>
                                </tr>
                                {% endfor %}
                                <!-- <tr>
                                    <td colspan="6" class="border border-gray-300 text-center py-5 text-gray-600">
                                        ไม่พบข้อมูลใบเสร็จ
                                        {% if search_query %}
                                            สำหรับคำค้นหา "{{ search_query }}"
                                        {% endif %}
                                    </td>
                                </tr> -->

                            </tbody>
                        </table>
                    </div>
                    <div class="p-2 flex items-start gap-4">

                        
                        <!-- ฝั่งซ้าย: ตัวเลือกเพิ่มเติม -->
                        <div class="flex-1 text-sm space-y-0.5 ml-2">

                            <div class="flex items-center gap-2">
                                <label class="w-16">ชำระโดย</label>
                                {% for value,label in payment_choices %}
                                <input type="radio" id="payment_method_{{ forloop.counter }}" name="payment_method" value="{{value}}" class="accent-blue-600">
                                <label class="mr-3" for="payment_method_{{ forloop.counter }}">{{label}}</label>
                                {% endfor %}
                                <!-- <input type="radio" name="pay_type" value="cash"> เงินสด
                                <input type="radio" name="pay_type" value="cheque" class="ml-2"> เช็ค
                                <input type="radio" name="pay_type" value="transfer" class="ml-2"> เงินโอน
                                <input type="radio" name="pay_type" value="other" class="ml-2"> อื่นๆ -->
                            </div>

                            <div class="flex items-center gap-2">
                                <label class="w-16">ธนาคาร</label>
                                <input type="text" name="bank_1" id="bank_1" class="w-12 px-1 py-0.5 border border-gray-600 bg-gray-50">
                                <label class="">/</label>
                                <input type="text" name="bank_2" id="bank_2" class="w-16 px-1 py-0.5 border border-gray-600 bg-gray-50">
                                <label class="ml-2 whitespace-nowrap">เลขที่</label>
                                <input type="text" name="bank_no" id="bank_no" class="w-16 px-1 py-0.5 border border-gray-600 bg-gray-50">
                                <label class="ml-2 whitespace-nowrap">วันที่</label>
                                <input type="date" name="bank_date" id="bank_date" class="px-1 py-0.5 border border-gray-600 bg-gray-50">
                            </div>

                            <div class="flex items-center gap-2 ml-16 px-2">
                                <input type="checkbox" name="deduct_from_prepaid" id="deduct_from_prepaid">
                                <label for="deduct_from_prepaid">ลดหนี้จากชำระล่วงหน้า</label>

                            </div>

                            <div class="flex items-center gap-2 ml-12">

                                <input type="checkbox" name="withdraw_from_bankaccount" id="withdraw_from_bankaccount" class="ml-6">
                                <label for="withdraw_from_bankaccount">ตัดบัญชีเงินฝากส่วนตัว</label>
                                <input type="text" name="withdraw" id="withdraw" class="w-24 px-1 py-0.5 border border-gray-600 bg-gray-50">
                            </div>

                            <div class="flex items-center gap-2 ml-4">
                                <label class="ml-32">ยอดชำระสุทธิ</label>
                                <input type="text" name="total" id="total" class="w-24 px-1 py-0.5 border border-gray-600 bg-gray-50">
                            </div>

                            <div class="flex items-center gap-2">
                                <label class="w-48">เลขที่หนังสือรับรองการหักภาษี</label>
                                <input type="text" name="tax_no" id="tax_no" class="w-32 px-1 py-0.5 border border-gray-600 bg-gray-50">  
                            </div>

                            <div class="flex items-center gap-2 ml-32 px-1">
                                <label>ลงวันที่</label>
                                <input type="date" name="tax_date" id="tax_date" class="w-32 px-1 py-0.5 border border-gray-600 bg-gray-50 ml-5">
                            </div>

                            <div class="flex items-center gap-2">
                                <label class="w-24">เลขที่อ้างอิง</label>
                                <input type="text" name="no_ref" id="no_ref" class="w-64 px-1 py-0.5 border border-gray-600 bg-gray-50">
                            </div>

                            <div class="flex items-center gap-2">
                                <label class="w-24">หมายเหตุ</label>
                                <input type="text" name="remark_1" id="remark_1" class="w-96 px-1 py-0.5 border border-gray-600 bg-gray-50">
                            </div>

                            <div class="flex items-center gap-2 ml-20 px-1">
                                <input type="text" name="remark_2" id="remark_2" class="w-96 px-1 py-0.5 border border-gray-600 bg-gray-50 ml-5 -mt-0.5">
                            </div>

                        </div>

                        <div class="text-right w-full">
                            <div class="block my-0.5">
                                <label for="cb1">มูลค่าฯไม่คิดภาษี</label>
                                <input type="text" name="value_n" id="cb1" class="ml-1 w-24 px-1 py-0.5 border border-gray-600 bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500 text-right">
                            </div>
                            <div class="block my-0.5">
                                <label for="cb2">มูลค่าฯคิดภาษี</label>
                                <input type="text" name="value_v" id="cb2" class="ml-1 w-24 px-1 py-0.5 border border-gray-600 bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500 text-right">
                            </div>
                            <div class="block my-0.5">
                                <label for="cb3">ภาษีมูลค่าเพิ่ม</label>
                                <input type="text" name="vat" id="cb3" class="ml-1 w-24 px-1 py-0.5 border border-gray-600 bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500 text-right">
                            </div>
                            <div class="block my-0.5">
                                <label for="cb4">รวมเงินทั้งสิ้น</label>
                                <input type="text" name="total_amount" id="cb4" class="ml-1 w-24 px-1 py-0.5 border border-gray-600 bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500 text-right">
                            </div>
                            <div class="block my-0.5">
                                <label for="cb5">ภาษีหัก ณ ที่จ่าย</label>
                                <input type="checkbox" name="vat" id="vat">
                                <input type="text" name="paid_amount" id="cb5" class="ml-1 w-24 px-1 py-0.5 border border-gray-600 bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500 text-right">
                            </div>
                            <div class="block my-0.5">
                                <label for="cb6">จำนวนเงินสุทธิ</label>
                                <input type="text" name="outstanding_amount" id="cb6" class="ml-1 w-24 px-1 py-0.5 border border-gray-600 bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500 text-right">
                            </div>
                            <div class="block my-0.5">
                                <label for="cb7">รับเงิน F8</label>
                                <input type="text" name="outstanding_amount" id="cb7" class="ml-1 w-24 px-1 py-0.5 border border-gray-600 bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500 text-right">
                            </div>
                            <div class="block my-0.5">
                                <label for="cb8">เงินทอน</label>
                                <input type="text" name="outstanding_amount" id="cb8" class="ml-1 w-24 px-1 py-0.5 border border-gray-600 bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500 text-right">
                            </div>
                        </div>
                    </div>
                </div>

            </form>
        </div>
    </div>

    <!-- Modal สำหรับบิลค้างชำระ -->
    <div id="unpaidModal" tabindex="-1" aria-hidden="true"
        class="fixed top-0 left-0 right-0 z-50 hidden w-full p-4 overflow-x-hidden overflow-y-auto h-[calc(100%-1rem)] max-h-full bg-black bg-opacity-50 flex items-start justify-center">
        <div class="relative w-full max-w-4xl max-h-full mx-auto">
            <div class="relative bg-white rounded-lg shadow">
                <div class="flex items-center justify-center p-4 border-b rounded-t">
                    <h3 class="text-xl font-semibold text-gray-900 text-center w-full">
                        รายการค้างชำระ
                    </h3>
                    <button type="button" class="absolute right-4 top-4 text-gray-400 bg-transparent hover:bg-gray-200 hover:text-gray-900 rounded-lg text-sm p-1.5 ml-auto inline-flex items-center" data-modal-hide="unpaidModal">
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 011.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                        </svg>
                    </button>
                </div>
                <div class="p-6 space-y-6 overflow-auto max-h-[500px]">
                    <table class="w-full text-sm text-center text-gray-700 border border-gray-300">
                        <thead class="bg-gray-200 text-gray-800">
                            <tr>
                                <th class="px-2 py-1 border border-gray-300">เดือน/ปี/งวด</th>
                                <th class="px-2 py-1 border border-gray-300">เลขที่บิล</th>
                                <th class="px-2 py-1 border border-gray-300">รหัส</th>
                                <th class="px-24 py-1 border border-gray-300">รายการ</th>
                                <th class="px-2 py-1 border border-gray-300">จำนวนเงิน</th>
                                <th class="px-2 py-1 border border-gray-300">คงค้าง</th>
                                <th class="px-2 py-1 border border-gray-300">เบี้ยปรับ</th>
                                <th class="px-2 py-1 border border-gray-300">ยอดชำระ</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white" id="dataTableBody">
                            <!-- {% for col in data_table %}
                            <tr onclick=""
                             class="cursor-pointer hover:bg-blue-100 even:bg-gray-50 border-b border-gray-200">
                                <td class="px-2 py-1 border border-gray-300">{{ col.m_y_prd }}</td>
                                <td class="px-2 py-1 border border-gray-300">{{ col.bill_no }}</td>
                                <td class="px-2 py-1 border border-gray-300">{{ col.item_code }}</td>
                                <td class="px-2 py-1 border border-gray-300">{{ col.description }}</td>
                                <td class="px-2 py-1 border border-gray-300">{{ col.amount }}</td>
                                <td class="px-2 py-1 border border-gray-300">-</td>
                                <td class="px-2 py-1 border border-gray-300">-</td>
                                <td class="px-2 py-1 border border-gray-300">-</td>
                            </tr>
                            {% empty %}
                            <tr><td colspan="8" class="text-center py-4 text-gray-500">ไม่พบรายการค้างชำระ</td></tr>
                            {% endfor %} -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
    // Global variables
    let currentRecordId = null;
    let formMode = 'view';
    let selectedRow = null;
    let selectedRows = [];

    // Print report
    function printReport() {
        window.print();
    }

    // Show loading
    function showLoading() {
        document.getElementById('loading').classList.remove('hidden');
    }

    // Hide loading
    function hideLoading() {
        document.getElementById('loading').classList.add('hidden');
    }

    // บิลค้างชำระ
    function getModal() {
        const data_table1 = JSON.parse(`{{ data_table_json|safe|escapejs }}`);
        const room_no1 = document.getElementById("room_no_1").value;
        const selected_modal = [];

        data_table1.forEach(item => {
            if (item.room_no == room_no1) {
                selected_modal.push(item);
                
            }
        });
        console.log(selected_modal);

        const tbody = document.getElementById("dataTableBody");
        tbody.innerHTML = '';

        // ตัวแปรเก็บข้อมูลแถวที่เลือก
        // const selectedRows = [];

        selected_modal.forEach(col => {
            const tr = document.createElement("tr");
            tr.className = "cursor-pointer hover:bg-blue-100 even:bg-gray-50 border-b border-gray-200";

            // สร้าง property id เพื่อเช็คใน selectedRows ง่ายขึ้น
            const rowKey = `${col.bill_no}_${col.item_code}_${col.m_y_prd}`;
            tr.dataset.rowKey = rowKey;

            // เพิ่ม onclick event (ตัวอย่าง alert แสดงเลขบิล)
            tr.onclick = function() {
                const key = this.dataset.rowKey;
                const index = selectedRows.findIndex(row => (
                    `${row.bill_no}_${row.item_code}_${row.m_y_prd}` === key
                ));

                if (index === -1) {
                    // ยังไม่อยู่ในรายการ → เพิ่ม
                    this.classList.add("!bg-blue-300");
                    selectedRows.push(col);
                } else {
                    // อยู่แล้ว → ลบ
                    this.classList.remove("!bg-blue-300");
                    selectedRows.splice(index, 1);
                }

                console.log("selectedRows", selectedRows);
            };
            
            tr.innerHTML = `
                <td class="px-2 py-1 border border-gray-300">${col.m_y_prd}</td>
                <td class="px-2 py-1 border border-gray-300">${col.bill_no}</td>
                <td class="px-2 py-1 border border-gray-300">${col.item_code}</td>
                <td class="px-2 py-1 border border-gray-300">${col.description}</td>
                <td class="px-2 py-1 border border-gray-300">${col.amount}</td>
                <td class="px-2 py-1 border border-gray-300">-</td>
                <td class="px-2 py-1 border border-gray-300">-</td>
                <td class="px-2 py-1 border border-gray-300">-</td>
            `;
            tbody.appendChild(tr);
        });

        if (selected_modal.length == 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="8" class="text-center py-4 text-gray-500">ไม่พบรายการค้างชำระ</td>
                </tr>
            `;
        }
    }

    // Set form mode
    function setFormMode(mode) {
        formMode = mode;
        const inputs = document.querySelectorAll('#formSection input[type="text"], ' +
            '#formSection input[type="date"], ' +
            '#formSection input[type="radio"], ' +
            '#formSection input[type="checkbox"]'
        );
        
        const btnUnpaid = document.getElementById('btnUnpaid');

        if (mode === 'view') {
            inputs.forEach(input => {
                input.disabled = true;
                
                if (['text', 'date', 'number'].includes(input.type)) {
                    input.style.backgroundColor = '#f0f0f0';  // เทาอ่อน vs ขาว
                }
                
            });

            // ปิดการใช้งานปุ่ม บิลค้างชำระ
            if (btnUnpaid) {
                btnUnpaid.disabled = true;
                btnUnpaid.classList.add("opacity-50", "cursor-not-allowed");
            }

        } else if (mode === 'edit' || mode === 'new') {
            inputs.forEach(input => {
                input.disabled = false;
                if (['text', 'date', 'number'].includes(input.type)) {
                    input.style.backgroundColor = '#ffffff';  // เทาอ่อน vs ขาว
                }
            });

            // เปิดใช้งานปุ่ม บิลค้างชำระ
            if (btnUnpaid) {
                btnUnpaid.disabled = false;
                btnUnpaid.classList.remove("opacity-50", "cursor-not-allowed");
            }
        }
    }

    // Clear form
    function clearForm() {
        document.querySelectorAll('#formSection input[type="text"], #formSection input[type="date"]').forEach(input => {
            input.value = '';
        });
        document.querySelectorAll('#formSection input[type="radio"], #formSection input[type="checkbox"]').forEach(input => {
            input.checked = false;
        });
        currentRecordId = null;
    }

    // New record
    function new_Record() {
        console.log('newrecord...');
        // Clear form
        document.querySelectorAll('#formSection input[type="text"], #formSection input[type="date"]').forEach(input => {
            input.value = '';
        });
        
        document.querySelectorAll('#formSection input[type="radio"], #formSection input[type="checkbox"]').forEach(input => {
            input.checked = false;
        });

        // Set current date
        const today = new Date();
        let data1 = JSON.parse(`{{ data_json|safe|escapejs }}`);

        // แยก string ด้วย '/'
        let [a, b] = data1[0].r_c_no.split('/');  // ['ABC', '005']

        b = parseInt(b, 10) + 1;  // แปลงเป็น int แล้ว +1

        // แปลง b ให้เป็น string 3 หลัก โดยเติม 0 ข้างหน้า
        b = b.toString().padStart(3, '0');  // เช่น 6 => "006"

        // รวมกลับด้วย '/'
        let result = [a, b].join('/');

        document.getElementById('r_c_no').value = result;
        document.getElementById('date').value = today.toISOString().split('T')[0];

        console.log(result);
        
        currentRecordId = null;
        setFormMode('new');
        
        // Clear table selection
        if (selectedRow) {
            selectedRow.classList.remove('!bg-red-100');
            selectedRow = null;
        }
        // ✅ เคลียร์ตารางขวา (dataTable1)
        const rows = document.querySelectorAll("#dataTable1 tr");
        rows.forEach(tr => {
            const cols = tr.querySelectorAll("td");
            for (let i = 1; i < cols.length; i++) {
                cols[i].textContent = "";
            }
            delete tr.dataset.rowKey;  // ลบ rowKey ออกด้วย
        });

        // ✅ reset selectedRows ด้วย
        selectedRows = [];
    }

    // Select record in table
    function selectRecord(row, recordId) {
        // Remove previous selection
        if (selectedRow) {
            selectedRow.classList.remove('!bg-red-100');
        }
        
        // Add selection to clicked row
        row.classList.add('!bg-red-100');
        selectedRow = row;
        
        // Load record details
        loadRecordDetails(recordId);
    }

    // Load record details from table row
    function loadRecordDetails(recordId) {
        const row = document.querySelector(`tr[data-id="${recordId}"]`);
        if (!row) return;

        const cell_r_c_no = row.cells[1].textContent.trim();
        const data_form = JSON.parse(`{{ data_json|safe|escapejs }}`);
        let click_id = null;

        console.log(cell_r_c_no)

        for (let i = 0; i < data_form.length; i++) {
            if (data_form[i].r_c_no.trim() === cell_r_c_no) {
                click_id = data_form[i];
                break;
            }
        }

        // Fill form with record data from table
        document.getElementById('r_c_no').value = click_id.r_c_no;
        document.getElementById('date').value = click_id.date;
        document.getElementById('payin').value = click_id.payin;
        document.getElementById('room_no_1').value = click_id.room_no_1; 
        document.getElementById('room_no_2').value = click_id.room_no_2;
        document.getElementById('member_1').value = click_id.member_1; 
        document.getElementById('member_2').value = click_id.member_2;
        

        const typeRadios = document.getElementsByName('type');
        
        for (let i = 0; i < typeRadios.length; i++) {
            console.log('radio',typeRadios[i]);
            if (typeRadios[i].value === click_id.type) {
                typeRadios[i].checked = true;
                break;
            }
        }

        const typeRadios2 = document.getElementsByName('payment_method');
        
        for (let i = 0; i < typeRadios2.length; i++) {
            console.log('radio',typeRadios2[i]);
            if (typeRadios2[i].value === click_id.payment_method) {
                typeRadios2[i].checked = true;
                break;
            }
        }
        
        document.getElementById('bank_1').value = click_id.bank_1; 
        document.getElementById('bank_2').value = click_id.bank_2;
        document.getElementById('bank_no').value = click_id.bank_no; 
        document.getElementById('bank_date').value = click_id.bank_date;
        document.getElementById('vat').checked = click_id.vat;
        document.getElementById('deduct_from_prepaid').checked = click_id.deduct_from_prepaid; 
        document.getElementById('withdraw_from_bankaccount').checked = click_id.withdraw_from_bankaccount;
        document.getElementById('withdraw').value = click_id.withdraw;
        document.getElementById('total').value = click_id.total;
        document.getElementById('tax_no').value = click_id.tax_no;
        document.getElementById('tax_date').value = click_id.tax_date;

        document.getElementById('no_ref').value = click_id.no_ref;
        document.getElementById('remark_1').value = click_id.remark_1;
        document.getElementById('remark_2').value = click_id.remark_2;

        
        
        currentRecordId = recordId;
        console.log(currentRecordId)
        setFormMode('view');

        // ✅ เคลียร์ dataTable1 ทุกครั้งที่เลือกใบเสร็จใหม่
        const rows = document.querySelectorAll("#dataTable1 tr");
        rows.forEach(tr => {
            const cols = tr.querySelectorAll("td");
            for (let i = 1; i < cols.length; i++) {
                cols[i].textContent = "";
            }
        });

        // ✅ reset ตัวแปร selectedRows ด้วย
        selectedRows = [];

        // ✅ ดึงรายการบิลที่ textstamp = r_c_no มาแสดงใน dataTable1
        fetch(`/m35/?action=get_items&r_c_no=${cell_r_c_no}`)
        .then(res => res.json())
        .then(data => {
            if (data.status === "success") {
                const rows = document.querySelectorAll("#dataTable1 tr");
                rows.forEach((tr, index) => {
                    const cols = tr.querySelectorAll("td");
                    if (index < data.items.length) {
                        const item = data.items[index];
                        cols[1].textContent = item.item_code;
                        cols[2].textContent = item.description;
                        cols[3].textContent = item.rate;
                        cols[4].textContent = item.quantity;
                        cols[5].textContent = item.amount;
                    } else {
                        for (let i = 1; i < cols.length; i++) {
                            cols[i].textContent = "";
                        }
                        delete tr.dataset.rowKey;
                    }
                });

                updateVatSummary();

            }
        });
    }

    function updateVatSummary() {
        // ✅ รวมค่าจาก column "เป็นเงิน"
        let totalAmount = 0;
        const rows = document.querySelectorAll("#dataTable1 tr");

        rows.forEach(tr => {
            const cols = tr.querySelectorAll("td");
            if (cols.length > 5) {
                const amountText = cols[5].textContent.trim();
                if (amountText !== "") {
                    totalAmount += parseFloat(amountText) || 0;
                }
            }
        });

        // ✅ ถ้ามีข้อมูล → คำนวณ VAT
        if (totalAmount > 0) {
            const vatRate = 0.07; // 7%
            const valueVat = totalAmount * vatRate;
            const vatInclude = totalAmount + valueVat;
            const nonTaxValue = 0;

            document.getElementById("cb1").value = nonTaxValue.toFixed(2);
            document.getElementById("cb2").value = totalAmount.toFixed(2);
            document.getElementById("cb3").value = valueVat.toFixed(2);
            document.getElementById("cb4").value = vatInclude.toFixed(2);
            document.getElementById("cb6").value = vatInclude.toFixed(2);
        } else {
            // ถ้าไม่มีข้อมูล → เคลียร์ช่อง
            document.getElementById("cb1").value = "";
            document.getElementById("cb2").value = "";
            document.getElementById("cb3").value = "";
            document.getElementById("cb4").value = "";
            document.getElementById("cb6").value = "";
        }
    }

    function getCookie(name) {
        // ฟังก์ชันช่วยดึงค่า CSRF token จาก cookie
        let cookieValue = null;
        if (document.cookie) {
            const cookies = document.cookie.split(';');
            for (let cookie of cookies) {
                cookie = cookie.trim();
                if (cookie.startsWith(name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // Save record
    function saveRecord() {
        const formData = new FormData();
        
        // Collect form data
        formData.append('r_c_no', document.getElementById('r_c_no').value);
        formData.append('date', document.getElementById('date').value);
        formData.append('payin', document.getElementById('payin').value);
        formData.append('room_no_1', document.getElementById('room_no_1').value);
        formData.append('room_no_2', document.getElementById('room_no_2').value);
        formData.append('member_1', document.getElementById('member_1').value);
        formData.append('member_2', document.getElementById('member_2').value);


        // Radio button: 'type'
        let typeValue = '';
        document.getElementsByName('type').forEach(el => {
            if (el.checked) typeValue = el.value;
        });
        formData.append('type', typeValue);

        // Radio button: 'payment_method'
        let paymentMethodValue = '';
        document.getElementsByName('payment_method').forEach(el => {
            if (el.checked) paymentMethodValue = el.value;
        });
        formData.append('payment_method', paymentMethodValue);

        // formData.append('type', document.getElementsByName('type').value);
        // formData.append('payment_method', document.getElementsByName('payment_method').value);
        formData.append('bank_1', document.getElementById('bank_1').value);
        formData.append('bank_2', document.getElementById('bank_2').value);
        formData.append('bank_no', document.getElementById('bank_no').value);
        formData.append('bank_date', document.getElementById('bank_date').value);
        formData.append('vat', document.getElementById('vat').checked);

        formData.append('deduct_from_prepaid', document.getElementById('deduct_from_prepaid').checked);
        formData.append('withdraw_from_bankaccount', document.getElementById('withdraw_from_bankaccount').checked);
        formData.append('withdraw', document.getElementById('withdraw').value);
        formData.append('total', document.getElementById('total').value);
        formData.append('tax_no', document.getElementById('tax_no').value);
        formData.append('tax_date', document.getElementById('tax_date').value);
        formData.append('no_ref', document.getElementById('no_ref').value);
        formData.append('remark_1', document.getElementById('remark_1').value);
        formData.append('remark_2', document.getElementById('remark_2').value);

        if (currentRecordId) {
        formData.append('id', currentRecordId);
        }

        // Validate required fields
        if (!formData.get('r_c_no') || !formData.get('date') || !formData.get('member_1')) {
            showMessage('กรุณากรอกข้อมูลที่จำเป็นให้ครบถ้วน', 'error');
            return;
        }

            // ✅ แนบข้อมูลบิล (selectedRows) เพิ่มเข้าไป
        if (selectedRows.length > 0) {
            formData.append("bills", JSON.stringify(selectedRows));
        }

        showLoading();
        
        fetch('/m35/', {  // เปลี่ยน URL ให้ตรงกับ path ของ view m35 ใน urls.py
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'), // ใส่ CSRF token ให้ Django เช็ค
        },
        body: formData
        })
        .then(response => {
            hideLoading();
            if (!response.ok) throw new Error('เกิดข้อผิดพลาดจาก server');
            return response.json();
        })
        .then(data => {
            if (data.status === 'success' || data.message.includes('เพิ่มเรียบร้อยแล้ว')) {
                // ✅ เมื่อบันทึกใบเสร็จสำเร็จ → update textstamp ของบิล
                showMessage(data.message || 'บันทึกข้อมูลเรียบร้อยแล้ว', 'success');
                setFormMode('view');

                setTimeout(() => {
                window.location.reload();  // ✅ รีโหลดทั้งหน้า
                }, 1000);  // รอ 1 วินาทีให้แสดงข้อความก่อน

                // // Clear form
                // document.querySelectorAll('#formSection input[type="text"], #formSection input[type="date"]').forEach(input => {
                //     input.value = '';
                // });
                
                // document.querySelectorAll('#formSection input[type="radio"], #formSection input[type="checkbox"]').forEach(input => {
                //     input.checked = false;
            // });

            } else {
                showMessage(data.message || 'เกิดข้อผิดพลาดในการบันทึกข้อมูล', 'error');
            }
        })
        .catch(error => {
            hideLoading();
            showMessage(error.message || 'เกิดข้อผิดพลาดในการติดต่อ server', 'error');
        });

        

        // Simulate save (replace with actual AJAX call)
        // setTimeout(() => {
        //     hideLoading();
        //     showMessage(currentRecordId ? 'แก้ไขข้อมูลเรียบร้อยแล้ว' : 'บันทึกข้อมูลเรียบร้อยแล้ว', 'success');
            
        //     if (!currentRecordId) {
        //         // Refresh page for new record
        //         setTimeout(() => {
        //             window.location.reload();
        //         }, 1000);
        //     } else {
        //         setFormMode('view');
        //     }
        // }, 1000);
    }

    // ✅ ฟังก์ชันย่อย: อัปเดต textstamp
    // function updateTextstamp() {
    //     if (selectedRows.length === 0) return;

    //     const r_c_no = document.getElementById("r_c_no").value;
    //     const payload = {
    //         r_c_no: r_c_no,
    //         bills: selectedRows.map(row => ({
    //             bill_no: row.bill_no,
    //             item_code: row.item_code,
    //             m_y_prd: row.m_y_prd
    //         }))
    //     };

    //     fetch("/update_textstamp/", {
    //         method: "POST",
    //         headers: {
    //             "Content-Type": "application/json",
    //             "X-CSRFToken": getCookie("csrftoken")
    //         },
    //         body: JSON.stringify(payload)
    //     })
    //     .then(res => res.json())
    //     .then(data => {
    //         if (data.status === "success") {
    //             console.log("update textstamp success", data.updated);
    //         } else {
    //             console.error("update textstamp error", data);
    //         }
    //     });
    // }

    // Edit record
    function editRecord() {
        if (currentRecordId) {
            setFormMode('edit');
        } else {
            showMessage('กรุณาเลือกข้อมูลที่ต้องการแก้ไข', 'error');
        }
    }

    // Delete record
    function deleteRecord() {
        if (!currentRecordId) {
            showMessage('กรุณาเลือกข้อมูลที่ต้องการลบ', 'error');
            return;
        }

        if (!confirm('คุณแน่ใจหรือไม่ที่จะลบข้อมูลนี้?')) {
            return;
        }

        showLoading();
        
        // Send a DELETE request to the server
        fetch(`/m35/${currentRecordId}`, { // Use the record's ID in the URL
            method: 'DELETE',
            headers: {
                'X-CSRFToken': getCookie('csrftoken') // Include the CSRF token
            }
        })
        .then(response => {
            hideLoading();
            if (response.ok) {
                return response.json();
            } else {
                // Handle HTTP errors
                throw new Error('เกิดข้อผิดพลาดในการลบข้อมูล');
            }
        })
        .then(data => {
            if (data.status === 'success') {
                showMessage('ลบข้อมูลเรียบร้อยแล้ว', 'success');
                // Remove the row from the DOM after successful deletion
                if (selectedRow) {
                    selectedRow.remove();
                    selectedRow = null;
                }
                clearForm();
                setFormMode('view');
            } else {
                showMessage(data.message || 'เกิดข้อผิดพลาดในการลบข้อมูล', 'error');
            }
        })
        .catch(error => {
            hideLoading();
            showMessage(error.message || 'เกิดข้อผิดพลาดในการติดต่อ server', 'error');
        });
    }

    function cancelEdit() {
        // กลับเป็น view mode
        setFormMode('view');

        // ถ้ามี record ที่เลือกอยู่ → โหลดข้อมูลจาก database ใหม่
        if (currentRecordId) {
            loadRecordDetails(currentRecordId);
        } else {
            // ถ้าไม่มี record ที่เลือก → เคลียร์ฟอร์ม
            clearForm();
        }
    }

    // Keyboard shortcuts
    document.addEventListener('keydown', function(e) {
        if (e.key === 'F2') {
            e.preventDefault();
            new_Record();
        } else if (e.key === 'F3') {
            e.preventDefault();
            editRecord();
        } else if (e.key === 'F4') {
            e.preventDefault();
            deleteRecord();
        } else if (e.key === 'F5') {
            e.preventDefault();
            const searchInput = document.querySelector('input[name="search"]');
            if (searchInput) searchInput.focus();
        } else if (e.key === 'F6') {
            e.preventDefault();
            printReport();
        } else if (e.key === 'F7') {
            e.preventDefault();
            if (confirm('ต้องการออกจากโปรแกรมหรือไม่?')) {
                window.close();
            }
        } else if (e.ctrlKey && e.key === 's') {
            e.preventDefault();
            if (formMode === 'edit' || formMode === 'new') {
                saveRecord();
            }
        } else if (e.key === 'Escape') {
            e.preventDefault();
            if (formMode === 'edit' || formMode === 'new') {
                cancelEdit();
            }
        }
        else if (e.key === 'F10') {
            e.preventDefault();

            // หา element ปุ่มปิด (กากบาท)
            const modal = document.getElementById("unpaidModal");

            if (modal && !modal.classList.contains("hidden")) {
                // ✅ modal กำลังแสดง → ปิด modal
                const closeBtn = modal.querySelector('[data-modal-hide="unpaidModal"]');
                if (closeBtn) {
                    closeBtn.click();
                }
            } else {
                // ✅ modal ไม่แสดง → กด F10 ให้ทำงานเหมือนกดบันทึก
                saveRecord();
            }
             
            // เช็คค่า selectedRows ยังอยู่ไหม
            console.log("F10: ปิด modal");
            console.log("selectedRows:", selectedRows);

            // ดึงทุกแถวใน dataTable1
            const rows = document.querySelectorAll("#dataTable1 tr");

            // หาตำแหน่งแถวสุดท้ายที่มีข้อมูลอยู่แล้ว
            let lastFilledIndex = -1;
            rows.forEach((tr, i) => {
                const cols = tr.querySelectorAll("td");
                if (cols[1].textContent.trim() !== "") {
                    lastFilledIndex = i;
                }
            });

            // เติมข้อมูลใหม่ต่อจากแถวสุดท้าย
            selectedRows.forEach((row, idx) => {
                const targetIndex = lastFilledIndex + 1 + idx;
                if (targetIndex < rows.length) {
                    const rowKey = `${row.bill_no}_${row.item_code}_${row.m_y_prd}`;

                    // เช็คว่ามี rowKey นี้แล้วหรือยัง
                    const exists = Array.from(rows).some(tr => tr.dataset.rowKey === rowKey);

                    if (!exists) {
                        const cols = rows[targetIndex].querySelectorAll("td");
                        rows[targetIndex].dataset.rowKey = rowKey;   // เก็บ key ไว้ที่ <tr>
                        cols[1].textContent = row.item_code;
                        cols[2].textContent = row.description;
                        cols[3].textContent = row.rate;
                        cols[4].textContent = row.quantity;
                        cols[5].textContent = row.amount;
                    }  else {
                        console.log("skip duplicate:", rowKey);
                    }
                }
            });

            // เคลียร์ selectedRows หลังใช้เสร็จ
            // selectedRows = [];

            // ✅ คำนวณภาษีใหม่ทุกครั้งที่มีการเลือกบิล
            updateVatSummary();

        }
    });

    // ✅ ฟังก์ชันค้นหาข้อมูลรหัส-ชื่อจากเลขที่ห้อง
    document.getElementById("room_no_1").addEventListener("keydown", function(e) {
        if (e.key === "Enter") {
            e.preventDefault();

            const roomNo = this.value.trim();
            if (!roomNo) return;

            const data_form = JSON.parse(`{{ data_artr|safe|escapejs }}`);

            const record = data_form.find(item => item.room_no_1 === roomNo);

            if (record) {
                document.getElementById("room_no_2").value = record.room_no_2 || "";
                document.getElementById("member_1").value = record.member_1 || "";
                document.getElementById("member_2").value = record.member_2 || "";
            } else {
                document.getElementById("room_no_2").value = "";
                document.getElementById("member_1").value = "";
                document.getElementById("member_2").value = "";
                alert("ไม่พบข้อมูลห้องนี้");
            }
        }
    });

    </script>
{% endblock %}