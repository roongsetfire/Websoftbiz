<!-- templates/index.html -->
{% extends 'base.html' %}

{% load static %}

{% block title %}M34{% endblock %}

{% block content %}
    <style>
        /* Custom styles that can't be easily done with Tailwind */
        .gradient-blue {
            background: linear-gradient(to bottom, #4a90e2, #357abd);
        }
        
        .gradient-gray {
            background: linear-gradient(to bottom, #f8f8f8, #e8e8e8);
        }
        
        .gradient-light-gray {
            background: linear-gradient(to bottom, #f0f0f0, #e0e0e0);
        }

        /* Animation for messages */
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        .animate-slide-in {
            animation: slideIn 0.3s ease-out;
        }

        /* Custom task grid */
        .task-grid {
            display: grid;
            grid-template-columns: 25px 1fr 60px 50px 70px;
            gap: 3px;
            margin-bottom: 8px;
        }
        /* ‡πÉ‡∏ä‡πâ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏°‡∏µ id="dataTable" */
        #dataTable {
            counter-reset: rowNumber;
        }

        #dataTable .row-number::before {
            counter-increment: rowNumber;
            content: counter(rowNumber) ".";
        }
        #dataTable1 {
            counter-reset: rowNumber;
        }

        #dataTable1 .row-number::before {
            counter-increment: rowNumber;
            content: counter(rowNumber) ".";
        }
        
        #formSection tbody input {
            width: 100%;
            height: 1.8rem;
            font-size: 0.88rem;
            padding: 0 10px;           /* ‡πÄ‡∏•‡πá‡∏Å‡∏ô‡∏¥‡∏î‡∏´‡∏ô‡πà‡∏≠‡∏¢‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏î‡πâ‡∏≤‡∏ô‡πÉ‡∏ô */
            margin: 0;                /* ‡∏ï‡∏±‡∏î margin ‡∏≠‡∏≠‡∏Å */
            border: none;             /* ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ border ‡∏Ç‡∏≠‡∏á input ‡πÄ‡∏≠‡∏á */
            box-sizing: border-box;   /* ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏ß‡∏°‡∏Ç‡∏≠‡∏ö */
            background-color: transparent !important;
        }
        #formSection tbody td {
            border: 1px solid #999; /* ‡∏´‡∏£‡∏∑‡∏≠ #ccc */
            padding: 0;
        }
        
    </style>

    <!-- Loading Indicator -->
    <div id="loading" class="fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-black bg-opacity-80 text-white p-5 rounded z-50 hidden">
        ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...
    </div>

    <!-- Messages -->
    <div id="messages" class="fixed top-12 right-5 z-40 max-w-xs"></div>

    <!-- CSRF Token -->
    {% csrf_token %}

    <!-- Title Bar -->
    <div class="gradient-blue text-white px-4 py-2 flex justify-center items-center relative font-bold text-sm">
        <span>‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢</span>

    </div>

    <div class="flex bg-green-100 font-thai overflow-hidden" style="height: calc(100vh - 80px);">
        
        <!-- Left Panel - Data Table (50% width) -->
        <div class="flex-1 bg-green-100 flex flex-col text-center">
            
            <!-- Table Container -->
            <div class="flex-1 bg-white overflow-auto border border-gray-400 m-1">
                <table class="w-full border-collapse">
                    <thead>
                        <tr>
                            <th class="gradient-light-gray border border-gray-600 px-2 py-1 font-bold sticky top-0 z-10 w-20">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô-‡∏á‡∏ß‡∏î</th>
                            <th class="gradient-light-gray border border-gray-600 px-2 py-1 font-bold sticky top-0 z-10 w-20">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
                            <th class="gradient-light-gray border border-gray-600 px-2 py-1 font-bold sticky top-0 z-10 w-20">‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏´‡∏ô‡∏µ‡πâ</th>
                            <th class="gradient-light-gray border border-gray-600 px-2 py-1 font-bold sticky top-0 z-10 w-20">‡∏´‡πâ‡∏≠‡∏á</th>
                            <th class="gradient-light-gray border border-gray-600 px-2 py-1 font-bold sticky top-0 z-10 w-32">‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</th>
                            <th class="gradient-light-gray border border-gray-600 px-2 py-1 font-bold sticky top-0 z-10 w-20">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</th>
                            <th class="gradient-light-gray border border-gray-600 px-2 py-1 font-bold sticky top-0 z-10 w-24">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</th>
                        </tr>
                    </thead>
                    <tbody id="dataTable">
                        {% for record in cmt_artr %}
                        <tr onclick="selectRecord(this, '{{ record.id }}')" data-id="{{ record.id }}" 
                            class="cursor-pointer hover:bg-blue-100 even:bg-gray-50 border-b border-gray-200">
                            <td class="border border-gray-300 px-2 py-1 whitespace-nowrap">{{ record.month|default:"-" }}</td>
                            <td class="border border-gray-300 px-2 py-1 whitespace-nowrap">{{ record.date|date:"d/m/Y" }}</td>
                            <td class="border border-gray-300 px-2 py-1 whitespace-nowrap">{{ record.bill_no }}</td>
                            <td class="border border-gray-300 px-2 py-1 whitespace-nowrap">{{ record.room_no_1 }}</td>
                            <td class="border border-gray-300 px-2 py-1 whitespace-nowrap">{{ record.member_2 }}</td>
                            <td class="border border-gray-300 px-2 py-1 text-center whitespace-nowrap">{{ record.amount|default:"-" }}</td>
                            <td class="border border-gray-300 px-2 py-1 whitespace-nowrap">{{ record.remark_1 }}</td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="7" class="border border-gray-300 text-center py-5 text-gray-600">
                                ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à
                                {% if search_query %}
                                    ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏≥‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ "{{ search_query }}"
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <!-- Navigation Buttons -->
            <div class="bg-green-100 px-2 py-1 flex gap-1 items-center">
                {% if page_obj.has_previous %}
                    <a href="?page=1{% if search_query %}&search={{ search_query }}{% endif %}{% if date_from %}&date_from={{ date_from }}{% endif %}{% if date_to %}&date_to={{ date_to }}{% endif %}" 
                       class="w-6 h-5 gradient-gray border border-gray-600 cursor-pointer flex items-center justify-center text-black no-underline hover:bg-gray-300">|&lt;</a>
                    <a href="?page={{ page_obj.previous_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}{% if date_from %}&date_from={{ date_from }}{% endif %}{% if date_to %}&date_to={{ date_to }}{% endif %}" 
                       class="w-6 h-5 gradient-gray border border-gray-600 cursor-pointer flex items-center justify-center text-black no-underline hover:bg-gray-300">&lt;</a>
                {% else %}
                    <span class="w-6 h-5 gradient-gray border border-gray-600 flex items-center justify-center text-black opacity-50 cursor-not-allowed">|&lt;</span>
                    <span class="w-6 h-5 gradient-gray border border-gray-600 flex items-center justify-center text-black opacity-50 cursor-not-allowed">&lt;</span>
                {% endif %}
                
                {% if page_obj.has_next %}
                    <a href="?page={{ page_obj.next_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}{% if date_from %}&date_from={{ date_from }}{% endif %}{% if date_to %}&date_to={{ date_to }}{% endif %}" 
                       class="w-6 h-5 gradient-gray border border-gray-600 cursor-pointer flex items-center justify-center text-black no-underline hover:bg-gray-300">&gt;</a>
                    <a href="?page={{ page_obj.paginator.num_pages }}{% if search_query %}&search={{ search_query }}{% endif %}{% if date_from %}&date_from={{ date_from }}{% endif %}{% if date_to %}&date_to={{ date_to }}{% endif %}" 
                       class="w-6 h-5 gradient-gray border border-gray-600 cursor-pointer flex items-center justify-center text-black no-underline hover:bg-gray-300">&gt;|</a>
                {% else %}
                    <span class="w-6 h-5 gradient-gray border border-gray-600 flex items-center justify-center text-black opacity-50 cursor-not-allowed">&gt;</span>
                    <span class="w-6 h-5 gradient-gray border border-gray-600 flex items-center justify-center text-black opacity-50 cursor-not-allowed">&gt;|</span>
                {% endif %}
                <div class="hotkey-hint flex items-center text-sm text-gray-600 ml-2">
                    <div class="ml-2 text-gray-600">
                        ‡∏´‡∏ô‡πâ‡∏≤ 1 / 3 (1-3 ‡∏à‡∏≤‡∏Å 25) | 
                    </div>
                    <button type="button" class="w-16 gradient-gray border border-gray-600 py-0.5 cursor-pointer hover:bg-gray-300 ml-2 rounded text-green-600" 
                     onclick="new_Record()">F2 ‡πÄ‡∏û‡∏¥‡πà‡∏°</button>
                    <button type="button" class="w-20 gradient-gray border border-gray-600 py-0.5 cursor-pointer hover:bg-gray-300 ml-2 rounded text-orange-600" 
                     onclick="saveRecord()">F10 ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                    <button type="button" class="w-16 gradient-gray border border-gray-600 py-0.5 cursor-pointer hover:bg-gray-300 ml-2 rounded text-blue-900" 
                     onclick="editRecord()">F3 ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                     <button type="button" class="w-16 gradient-gray border border-gray-600 py-0.5 cursor-pointer hover:bg-gray-300 ml-2 rounded text-red-600" 
                     onclick="deleteRecord()">F4 ‡∏•‡∏ö</button>
                    <button type="button" class="w-16 gradient-gray border border-gray-600 py-0.5 cursor-pointer hover:bg-gray-300 ml-2 rounded text-purple-600" 
                     onclick="">F5 ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button>
                    <button type="button" class="w-16 gradient-gray border border-gray-600 py-0.5 cursor-pointer hover:bg-gray-300 ml-2 rounded text-blue-600" 
                     onclick="">F6 ‡∏û‡∏¥‡∏°‡∏û‡πå</button>
                    <button type="button" class="w-16 gradient-gray border border-gray-600 py-0.5 cursor-pointer hover:bg-gray-300 ml-2 rounded text-yellow-500" 
                     onclick="">ESC ‡∏≠‡∏≠‡∏Å</button>
                </div>
            </div>
           
        </div>

        <!-- Right Panel (50% width) -->
        <div class="flex-1 bg-green-100 flex flex-col">
            <!-- Form Section -->
            <form method="POST" action="" id="formSection" class="bg-green-100 mb-0">
                {% csrf_token %}
                <div class="ml-10 mt-4 mb-2">
                    <div class="flex items-center gap-1 mb-0.5">
                        
                        <div class="flex items-center gap-1">
                            <label class="w-28 flex-shrink-0">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏´‡∏ô‡∏µ‡πâ</label>
                            <input type="text" name="bill_no" class="w-32 px-1 py-0.5 border border-gray-600 bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500" id="bill_no">
                        </div>
                        
                        
                        <div class="flex items-center gap-1">
                            <label class="w-8 flex-shrink-0 ml-6">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
                            <input type="date" name="date" class="w-32 px-1 py-0.5 border border-gray-600 bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500" id="date">
                            <!-- <button type="button" class="gradient-gray border border-gray-600 px-2 py-0.5 cursor-pointer hover:bg-gray-300 ml-1" onclick="printReport()">REPORT</button> -->
                        </div>
                        
                    </div>
                    
                    <div class="flex items-center gap-1 mb-0.5">
                        
                            <div class="flex items-center gap-1">
                                <label class="w-28 flex-shrink-0 px-5">‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</label>
                                <input type="text" name="month" class="w-8 px-1 py-0.5 border border-gray-600 bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500" id="month">
                                <label class="mx-1 ml-[1.7rem]">‡∏õ‡∏µ</label>
                                <input type="text" name="year" class="w-12 px-1 py-0.5 border border-gray-600 bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500" id="year">
                            </div>
                        
                        <div class="flex-1">
                            <div class="flex items-center gap-1">
                                <label class="w-8 flex-shrink-0 ml-6">‡∏á‡∏ß‡∏î</label>
                                <input type="text" name="prd" class="w-8 px-1 py-0.5 border border-gray-600 bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500" id="prd">
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex items-center gap-1 mb-0.5">
                        
                        <div class="flex items-center gap-1">
                            <label class="w-28 flex-shrink-0">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏´‡πâ‡∏≠‡∏á</label>
                            <input type="text" name="room_no_1" class="w-32 px-1 py-0.5 border border-gray-600 bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500" id="room_no_1">
                            <input type="text" name="room_no_2" class="w-60 px-1 py-0.5 border border-gray-600 bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500" id="room_no_2">
                        </div>      
                    </div>
                    
                    <div class="flex items-center gap-1 mb-0.5">
                        
                        <div class="flex items-center gap-1">
                            <label class="w-28 flex-shrink-0">‡∏£‡∏´‡∏±‡∏™-‡∏ä‡∏∑‡πà‡∏≠</label>
                            <input type="text" name="member_1" class="w-32 px-1 py-0.5 border border-gray-600 bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500" id="member_1">
                            <input type="text" name="member_2" class="w-96 px-1 py-0.5 border border-gray-600 bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500" id="member_2">
                        </div>   
                    </div>
                    
                    <div class="flex items-center gap-1 mb-0.5">
                        <label class="w-28 flex-shrink-0">‡∏ä‡∏≥‡∏£‡∏∞‡∏†‡∏≤‡∏¢‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
                        <input type="date" name="duedate" class="w-32 px-1 py-0.5 border border-gray-600 bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500" id="duedate">
                    </div>
                    
                    <input type="hidden" name="currentRecordId" id="currentRecordId" value="">
                    <input type="hidden" name="formMode" id="formMode" value="view">
                </div>

                <!-- Task List -->
                <div class="bg-green-100 flex-1 flex flex-col">
                    <div class="bg-white flex-1 overflow-auto border border-gray-400 mx-2">
                        <table class="w-full border-collapse table-fixed">
                            <thead>
                                <tr>
                                    <th class="gradient-light-gray border border-gray-600 py-1 font-bold sticky top-0 z-10 w-4">‡∏•‡∏≥‡∏î‡∏±‡∏ö</th>
                                    <th class="gradient-light-gray border border-gray-600 px-2 py-1 font-bold sticky top-0 z-10 w-7">‡∏£‡∏´‡∏±‡∏™</th>
                                    <th class="gradient-light-gray border border-gray-600 px-2 py-1 font-bold sticky top-0 z-10 w-32">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th>
                                    <th class="gradient-light-gray border border-gray-600 px-2 py-1 font-bold sticky top-0 z-10 w-10">‡∏≠‡∏±‡∏ï‡∏£‡∏≤-F12</th>
                                    <th class="gradient-light-gray border border-gray-600 px-2 py-1 font-bold sticky top-0 z-10 w-10">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th>
                                    <th class="gradient-light-gray border border-gray-600 px-2 py-1 font-bold sticky top-0 z-10 w-14">‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</th>
                                </tr>
                            </thead>
                            <tbody id="dataTable1">
                                {% for i in row_numbers %}
                                <tr class="cursor-pointer even:bg-gray-50 border-b border-gray-200">
                                    <td class="border border-gray-300 py-1 text-center row-number"></td>
                                    <td class="px-2 py-1 whitespace-nowrap">
                                        <input type="text" name="item_code[]" id="item_code_table" value="" 
                                               class="item_code w-full px-1 py-0.5 border border-gray-300 bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500 item-code"
                                               onkeypress="handleItemCode(event, this)">
                                    </td>
                                    <td class="px-2 py-1 whitespace-nowrap">
                                        <input type="text" name="description[]" id="description_table" value="" 
                                               class="description w-full px-1 py-0.5 border border-gray-300 bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500 description">
                                    </td>
                                    <td class="px-2 py-1 whitespace-nowrap">
                                        <input type="number" name="rate[]" id="rate_table" value="" 
                                               class="rate w-full px-1 py-0.5 border border-gray-300 bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500 rate" 
                                               onchange="calculateAmount(this)">
                                    </td>
                                    <td class="px-2 py-1 whitespace-nowrap">
                                        <input type="number" name="quantity[]" id="quantity_table" value="" 
                                               class="quantity w-full px-1 py-0.5 border border-gray-300 bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500 quantity" 
                                               onchange="calculateAmount(this)">
                                    </td>
                                    <td class="px-2 py-1 text-center whitespace-nowrap">
                                        <input type="text" name="amount[]" id="amount_table" value="" 
                                               class="amount w-full px-1 py-0.5 border border-gray-300 bg-gray-50 text-center" readonly>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    <div class="p-2 flex-1 flex flex-col">
                        <div class="flex justify-between items-start">
                            <div class="my-1 text-gray-600">
                                ? : / = ‡∏ä‡∏≥‡∏£‡∏∞‡πÅ‡∏•‡πâ‡∏ß , x = ‡∏ä‡∏≥‡∏£‡∏∞‡∏ö‡∏≤‡∏á‡∏™‡πà‡∏ß‡∏ô
                            </div>
                            <div class="text-right">
                                <div class="block">
                                    <label for="cb1">‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤/‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£N</label>
                                    <input type="text" name="value_n" id="cb1" class="ml-1 w-24 px-1 py-0.5 border border-gray-600 bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500" readonly>
                                </div>
                            </div>
                        </div>
                        <div class="text-right w-full">
                            <div class="block my-0.5">
                                <label for="cb2">‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤/‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£V</label>
                                <input type="text" name="value_v" id="cb2" class="ml-1 w-24 px-1 py-0.5 border border-gray-600 bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500" readonly>
                            </div>
                            <div class="block my-0.5">
                                <label for="cb3">‡∏†‡∏≤‡∏©‡∏µ‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°</label>
                                <input type="text" name="vat" id="cb3" class="ml-1 w-24 px-1 py-0.5 border border-gray-600 bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500" readonly>
                            </div>
                            <div class="block my-0.5">
                                <label for="cb4">‡∏£‡∏ß‡∏°‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏¥‡πâ‡∏ô</label>
                                <input type="text" name="total_amount" id="cb4" class="ml-1 w-24 px-1 py-0.5 border border-gray-600 bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500" readonly>
                            </div>
                            <div class="block my-0.5">
                                <label for="cb5">‡∏¢‡∏≠‡∏î‡∏ä‡∏≥‡∏£‡∏∞‡πÅ‡∏•‡πâ‡∏ß</label>
                                <input type="text" name="paid_amount" id="cb5" class="ml-1 w-24 px-1 py-0.5 border border-gray-600 bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500">
                            </div>
                            <div class="block my-0.5">
                                <label for="cb6">‡∏¢‡∏≠‡∏î‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞ ‡∏¢‡∏Å‡∏°‡∏≤</label>
                                <input type="text" name="outstanding_amount" id="cb6" class="ml-1 w-24 px-1 py-0.5 border border-gray-600 bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500" readonly>
                            </div>
                        </div>
                    
                    </div>
                </div>

                <!-- Notes Section -->
                <label class="flex gap-2 mb-1 ml-5 p-1 items-center pt-0 text-base">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label>
                <div class="flex gap-2 mt-1 ml-5 items-center">
                    <input type="text" name="remark_1" class="w-5/6 px-1 py-0.5 border border-gray-600 bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500" id="remark_1">
                </div>
                
                <div class="flex gap-2 mb-1 ml-5 items-center">
                    <input type="text" name="remark_2" class="w-5/6 px-1 py-0.5 border border-gray-600 bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500" id="remark_2">
                </div>

        
            </form>
        </div>
    </div>

    <script>
        // Load dictionary data from Django context
        const dictionary_data = JSON.parse(`{{ item_data_json|safe|escapejs }}`);

        // Handle item code input on Enter key
        function handleItemCode(event, input) {
            if (event.key === 'Enter') {
                event.preventDefault();
                const row = input.closest('tr'); // ‡∏´‡∏≤‡πÅ‡∏ñ‡∏ß‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
                const itemCode = input.value.trim();
                const item = dictionary_data[itemCode];

                if (item) {
                    row.querySelector('.description').value = item.description || '';
                    row.querySelector('.rate').value = item.rate || '';
                    // row.querySelector('.quantity').value = item.quantity || '';
                    // row.querySelector('.amount').value = (parseFloat(item.rate) * parseFloat(item.quantity)).toFixed(2);
                    updateSummary();
                } else {
                    alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤: ' + itemCode);
                    row.querySelector('.description').value = '';
                    row.querySelector('.rate').value = '';
                    row.querySelector('.quantity').value = '';
                    row.querySelector('.amount').value = '';
                    updateSummary();
                }
            }
        }

        // Calculate amount when rate or quantity changes
        function calculateAmount(input) {
            const row = input.closest('tr'); // Find the current row
            const rate = parseFloat(row.querySelector('.rate').value) || 0;
            const quantity = parseFloat(row.querySelector('.quantity').value) || 0;
            row.querySelector('.amount').value = (rate * quantity).toFixed(2);
            updateSummary();
        }

        // Update summary fields
        function updateSummary() {
            const rows = document.querySelectorAll('#dataTable1 tr');
            let totalAmount = 0;
            let valueN = 0;
            let valueV = 0;
            let vat = 0;
            const vatRate = 0.07;

            rows.forEach(row => {
                const itemCode = row.querySelector('#item_code_table')?.value.trim();
                const amount = parseFloat(row.querySelector('#amount_table')?.value) || 0;
                if (!itemCode) return;

                const isVatInclusive = itemCode === 'A101';
                if (isVatInclusive) {
                    const base = amount / (1 + vatRate);
                    valueV += base;
                    vat += base * vatRate;
                } else {
                    valueN += amount;
                }
                totalAmount += amount;
            });

            const paidAmount = parseFloat(document.getElementById('cb5').value) || 0;
            const outstandingAmount = totalAmount - paidAmount;

            document.getElementById('cb1').value = valueN.toFixed(2);
            document.getElementById('cb2').value = valueV.toFixed(2);
            document.getElementById('cb3').value = vat.toFixed(2);
            document.getElementById('cb4').value = totalAmount.toFixed(2);
            document.getElementById('cb5').value = paidAmount.toFixed(2);
            document.getElementById('cb6').value = outstandingAmount.toFixed(2);
        }
    </script>

    <script>
        // Global variables
        let currentRecordId = null;
        let formMode = 'view';
        let selectedRow = null;

        // Show message
        function showMessage(message, type = 'success') {
            const messageDiv = document.createElement('div');
            messageDiv.className = `p-2 mb-2 rounded animate-slide-in ${
                type === 'success' 
                    ? 'bg-green-100 border border-green-300 text-green-800' 
                    : 'bg-red-100 border border-red-300 text-red-800'
            }`;
            messageDiv.textContent = message;
            
            const container = document.getElementById('messages');
            container.appendChild(messageDiv);
            
            // Auto remove after 3 seconds
            setTimeout(() => {
                if (messageDiv.parentNode) {
                    messageDiv.parentNode.removeChild(messageDiv);
                }
            }, 3000);
        }

        // Set form mode - ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏ó‡∏µ‡πà‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏¥‡∏î/‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
        function setFormMode(mode) {
            formMode = mode;
            // ‡πÄ‡∏û‡∏¥‡πà‡∏° selector ‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏•‡∏∏‡∏°‡∏ó‡∏∏‡∏Å‡∏ü‡∏¥‡∏•‡∏î‡πå‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£
            const inputs = document.querySelectorAll('#formSection input[type="text"], ' +
                '#formSection input[type="text"], ' +
                '#formSection input[type="date"], ' +
                '#formSection input[type="number"], ' +
                '#dataTable1 input'
            );
            
            console.log('Setting form mode to:', mode);
            console.log('Found inputs:', inputs.length);
            
            if (mode === 'view') {
                inputs.forEach(input => {
                    input.disabled = true;
                    if (['text', 'date', 'number'].includes(input.type)) {
                        input.style.backgroundColor = '#f0f0f0';  // ‡πÄ‡∏ó‡∏≤‡∏≠‡πà‡∏≠‡∏ô
                    }
                });
                
                // ‡πÄ‡∏ä‡πá‡∏Ñ‡πÉ‡∏´‡πâ‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏ß‡πà‡∏≤‡∏ü‡∏¥‡∏•‡∏î‡πå‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ñ‡∏π‡∏Å disable
                const specificFields = ['prd', 'duedate', 'member_1'];
                specificFields.forEach(fieldId => {
                    const field = document.getElementById(fieldId);
                    if (field) {
                        field.disabled = true;
                        field.style.backgroundColor = '#f0f0f0';
                        console.log('Disabled field:', fieldId);
                    }
                });
                
            } else if (mode === 'edit' || mode === 'new') {
                inputs.forEach(input => {
                    input.disabled = false;
                    if (['text', 'date', 'number'].includes(input.type)) {
                        input.style.backgroundColor = '#ffffff';  // ‡∏Ç‡∏≤‡∏ß
                    }
                });
                
                // ‡πÄ‡∏ä‡πá‡∏Ñ‡πÉ‡∏´‡πâ‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏ß‡πà‡∏≤‡∏ü‡∏¥‡∏•‡∏î‡πå‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ñ‡∏π‡∏Å enable
                const specificFields = ['prd', 'duedate', 'member_1'];
                specificFields.forEach(fieldId => {
                    const field = document.getElementById(fieldId);
                    if (field) {
                        field.disabled = false;
                        field.style.backgroundColor = '#ffffff';
                        console.log('Enabled field:', fieldId);
                    }
                });
            }
            
            console.log('Form mode set to:', formMode);
        }

        // Clear form
        function clearForm() {
            document.querySelectorAll('#formSection input[type="text"], #formSection input[type="date"], #formSection input[type="number"]').forEach(input => {
                input.value = '';
            });
            currentRecordId = null;
        }

        // New record
        function new_Record() {
            console.log('newrecord...');
            // Clear form
            clearForm();
            
            // Set current date
            const today = new Date();
            document.getElementById('date').value = today.toISOString().split('T')[0];
            document.getElementById('month').value = String(today.getMonth() + 1).padStart(2, '0');
            document.getElementById('year').value = today.getFullYear();
            
            // ‡∏Ç‡∏≠‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏´‡∏ô‡∏µ‡πâ‡πÉ‡∏´‡∏°‡πà‡∏à‡∏≤‡∏Å server
            fetch('/m34/?action=get_new_bill_no')
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    document.getElementById('bill_no').value = data.bill_no;
                }
            })
            .catch(error => {
                console.error('Error getting new bill no:', error);
                // fallback: ‡πÉ‡∏ä‡πâ timestamp
                const timestamp = Date.now().toString().slice(-6);
                document.getElementById('bill_no').value = `BILL-${timestamp}`;
            });
            
            currentRecordId = null;
            setFormMode('new');
            
            // Clear table selection
            if (selectedRow) {
                selectedRow.classList.remove('!bg-red-100');
                selectedRow = null;
            }
        }

        // Select record in table
        function selectRecord(row, recordId) {
            // Remove previous selection
            if (selectedRow) {
                selectedRow.classList.remove('!bg-red-100');
            }
            
            // Add selection to clicked row
            row.classList.add('!bg-red-100');
            selectedRow = row;
            
            // Load record details
            loadRecordDetails(recordId);
        }

        // Load record details from table row
        function loadRecordDetails(recordId) {
            // ‡πÉ‡∏ä‡πâ AJAX ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å database ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á
            fetch(`/m34/?action=get_record&id=${recordId}`)
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    const record = data.record;
                    
                    // ‡πÉ‡∏™‡πà‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏•‡∏±‡∏Å‡πÉ‡∏ô‡∏ü‡∏≠‡∏£‡πå‡∏°
                    document.getElementById('bill_no').value = record.bill_no || '';
                    document.getElementById('date').value = record.date || '';
                    document.getElementById('month').value = record.month || '';
                    document.getElementById('year').value = record.year || '';
                    document.getElementById('prd').value = record.prd || '';  // ‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å database
                    document.getElementById('room_no_1').value = record.room_no_1 || '';
                    document.getElementById('room_no_2').value = record.room_no_2 || '';
                    document.getElementById('member_1').value = record.member_1 || '';  // ‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å database
                    document.getElementById('member_2').value = record.member_2 || '';
                    document.getElementById('duedate').value = record.duedate || '';
                    document.getElementById('remark_1').value = record.remark_1 || '';
                    document.getElementById('remark_2').value = record.remark_2 || '';
                    
                    // üî• ‡πÉ‡∏™‡πà‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á (‡∏´‡∏•‡∏≤‡∏¢‡πÅ‡∏ñ‡∏ß)
                    const tbody = document.getElementById('dataTable1');
                    tbody.innerHTML = ''; // ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡∏≠‡∏á‡πÄ‡∏Å‡πà‡∏≤‡∏≠‡∏≠‡∏Å‡∏Å‡πà‡∏≠‡∏ô

                    let items = record.items || [];
                    let totalRows = 8; // ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á 8 ‡πÅ‡∏ñ‡∏ß‡πÄ‡∏™‡∏°‡∏≠

                    for (let i = 0; i < totalRows; i++) {
                        const item = items[i] || {}; // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡πÉ‡∏ä‡πâ object ‡∏ß‡πà‡∏≤‡∏á
                        const row = document.createElement('tr');
                        row.className = "cursor-pointer even:bg-gray-50 border-b border-gray-200";

                        row.innerHTML = `
                            <td class="border border-gray-300 py-1 text-center">${i + 1}</td>
                            <td>
                                <input type="text" name="item_code[]" value="${item.item_code || ''}" 
                                    class="item_code w-full border px-1"
                                    onkeypress="handleItemCode(event, this)">
                            </td>
                            <td>
                                <input type="text" name="description[]" value="${item.description || ''}" 
                                    class="description w-full border px-1">
                            </td>
                            <td>
                                <input type="number" name="rate[]" value="${item.rate || ''}" 
                                    class="rate w-full border px-1" 
                                    onchange="calculateAmount(this)">
                            </td>
                            <td>
                                <input type="number" name="quantity[]" value="${item.quantity || ''}" 
                                    class="quantity w-full border px-1" 
                                    onchange="calculateAmount(this)">
                            </td>
                            <td>
                                <input type="text" name="amount[]" value="${item.amount || ''}" 
                                    class="amount w-full border px-1 text-center" readonly>
                            </td>
                        `;

                        tbody.appendChild(row);
                    }
                    
                    // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì VAT ‡πÉ‡∏´‡∏°‡πà‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡πÉ‡∏™‡πà‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                    updateSummary();
                    
                    setFormMode('view');

                    console.log('Loaded complete record from database:', record);
                } else {
                    // ‡∏ñ‡πâ‡∏≤ AJAX ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏ß‡∏¥‡∏ò‡∏µ‡πÄ‡∏î‡∏¥‡∏°‡∏à‡∏≤‡∏Å‡∏ï‡∏≤‡∏£‡∏≤‡∏á
                    loadFromTableCells(recordId);
                }
            })
            .catch(error => {
                console.error('Error loading record:', error);
                // ‡∏ñ‡πâ‡∏≤ AJAX error ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏ß‡∏¥‡∏ò‡∏µ‡πÄ‡∏î‡∏¥‡∏°‡∏à‡∏≤‡∏Å‡∏ï‡∏≤‡∏£‡∏≤‡∏á
                loadFromTableCells(recordId);
            });
            
            currentRecordId = recordId;
            
        }
        
        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏£‡∏≠‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏ï‡∏≤‡∏£‡∏≤‡∏á (‡∏ß‡∏¥‡∏ò‡∏µ‡πÄ‡∏î‡∏¥‡∏°) - ‡πÉ‡∏ä‡πâ‡πÄ‡∏°‡∏∑‡πà‡∏≠ AJAX ‡πÑ‡∏°‡πà‡∏ó‡∏≥‡∏á‡∏≤‡∏ô
        function loadFromTableCells(recordId) {
            const row = document.querySelector(`tr[data-id="${recordId}"]`);
            if (!row) return;

            const cells = row.cells;
            
            // Fill form with record data from table (‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏µ‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á)
            document.getElementById('bill_no').value = cells[2].textContent.trim();
            document.getElementById('date').value = formatDateForInput(cells[1].textContent);
            document.getElementById('month').value = cells[0].textContent.trim();
            document.getElementById('year').value = new Date().getFullYear();
            document.getElementById('room_no_1').value = cells[3].textContent.trim();
            document.getElementById('member_2').value = cells[4].textContent.trim();
            document.getElementById('remark_1').value = cells[5].textContent === '-' ? '' : cells[5].textContent.trim();
            document.getElementById('remark_2').value = cells[6].textContent.trim();
            
            // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á - ‡πÉ‡∏´‡πâ‡∏Ñ‡πà‡∏≤‡∏ß‡πà‡∏≤‡∏á‡∏´‡∏£‡∏∑‡∏≠‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
            document.getElementById('room_no_2').value = '';
            document.getElementById('member_1').value = ''; // ‡∏à‡∏∞‡∏ï‡πâ‡∏≠‡∏á‡∏õ‡πâ‡∏≠‡∏ô‡πÄ‡∏≠‡∏á‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á
            document.getElementById('prd').value = '';
            document.getElementById('duedate').value = '';
            
            console.log('Loaded record from table cells (fallback mode):', {
                id: recordId,
                bill_no: cells[2].textContent.trim(),
                room_no_1: cells[3].textContent.trim(),
                member_2: cells[4].textContent.trim(),
                note: 'member_1 and other fields need to be filled manually'
            });
        }

        // Format date for input field (DD/MM/YYYY to YYYY-MM-DD)
        function formatDateForInput(dateStr) {
            if (!dateStr || dateStr === '-') return '';
            
            const parts = dateStr.split('/');
            if (parts.length === 3) {
                const day = parts[0].padStart(2, '0');
                const month = parts[1].padStart(2, '0');
                const year = parts[2];
                return `${year}-${month}-${day}`;
            }
            return '';
        }

        // Edit record
        function editRecord() {
            if (currentRecordId) {
                setFormMode('edit');
            } else {
                showMessage('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç', 'error');
            }
        }

        // Cancel edit
        function cancelEdit() {
            if (currentRecordId) {
                loadRecordDetails(currentRecordId);
            } else {
                clearForm();
                setFormMode('view');
            }
        }

        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie) {
                const cookies = document.cookie.split(';');
                for (let cookie of cookies) {
                    cookie = cookie.trim();
                    if (cookie.startsWith(name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        // Save record
        function saveRecord() {
            // Debug: ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö form mode
            console.log('Current form mode:', formMode);
            if (formMode === 'view') {
                showMessage('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏î‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç (F3) ‡∏Å‡πà‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', 'error');
                return;
            }

            const formData = new FormData();
            
            // Collect form data
            formData.append('bill_no', document.getElementById('bill_no').value);
            formData.append('date', document.getElementById('date').value);
            formData.append('month', document.getElementById('month').value);
            formData.append('year', document.getElementById('year').value);
            formData.append('prd', document.getElementById('prd').value);
            formData.append('room_no_1', document.getElementById('room_no_1').value);
            formData.append('room_no_2', document.getElementById('room_no_2').value);
            formData.append('member_1', document.getElementById('member_1').value);
            formData.append('member_2', document.getElementById('member_2').value);
            formData.append('duedate', document.getElementById('duedate').value);
            formData.append('remark_1', document.getElementById('remark_1').value);
            formData.append('remark_2', document.getElementById('remark_2').value);

            // Add item data from table
            // --- ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• item ‡∏´‡∏•‡∏≤‡∏¢‡πÅ‡∏ñ‡∏ß ---
            document.querySelectorAll('#dataTable1 tr').forEach(row => {
                formData.append('item_code[]', row.querySelector('.item_code').value);
                formData.append('description[]', row.querySelector('.description').value);
                formData.append('rate[]', row.querySelector('.rate').value);
                formData.append('quantity[]', row.querySelector('.quantity').value);
                formData.append('amount[]', row.querySelector('.amount').value);
            });
            
            // Add calculated values
            formData.append('value_n', document.getElementById('cb1').value);
            formData.append('value_v', document.getElementById('cb2').value);
            formData.append('vat', document.getElementById('cb3').value);
            formData.append('total_amount', document.getElementById('cb4').value);
            formData.append('paid_amount', document.getElementById('cb5').value);
            formData.append('outstanding_amount', document.getElementById('cb6').value);

            if (currentRecordId) {
                formData.append('id', currentRecordId);
                formData.append('action', 'edit');
            } else {
                formData.append('action', 'create');
            }

            // Debug: ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏™‡πà‡∏á
            console.log('Form data to send:');
            for (let [key, value] of formData.entries()) {
                console.log(key, ':', value);
            }

            // Validate required fields
            if (!formData.get('bill_no') || !formData.get('date') || !formData.get('member_1')) {
                showMessage('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô (‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏´‡∏ô‡∏µ‡πâ, ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà, ‡∏£‡∏´‡∏±‡∏™-‡∏ä‡∏∑‡πà‡∏≠)', 'error');
                return;
            }

            showLoading();
            
            // Send AJAX request to save data
            fetch('/m34/', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                    'X-Requested-With': 'XMLHttpRequest',  // ‡∏ö‡∏≠‡∏Å‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô AJAX request
                },
                body: formData
            })
            .then(response => {
                console.log('Response status:', response.status);
                console.log('Response headers:', response.headers);
                
                hideLoading();
                
                if (!response.ok) {
                    return response.text().then(text => {
                        console.error('Server error response:', text);
                        throw new Error(`Server error: ${response.status} - ${text}`);
                    });
                }
                
                return response.json();
            })
            .then(data => {
                console.log('Server response:', data);
                
                if (data.status === 'success' || data.message?.includes('‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß') || data.message?.includes('‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß')) {
                    showMessage(data.message || '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß', 'success');
                    setFormMode('view');

                    // Reload page to show updated data
                    setTimeout(() => {
                        window.location.reload();
                    }, 1000);

                } else {
                    showMessage(data.message || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', 'error');
                }
            })
            .catch(error => {
                console.error('Fetch error:', error);
                hideLoading();
                showMessage(`‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${error.message}`, 'error');
            });
        }

        // Delete record
        // Delete record - Updated version with better error handling
        function deleteRecord() {
            if (!currentRecordId) {
                showMessage('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö', 'error');
                return;
            }

            // Show confirmation dialog
            if (!confirm('‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏µ‡πâ?')) {
                return;
            }

            showLoading();
            
            // Send AJAX request to delete data
            const formData = new FormData();
            formData.append('action', 'delete');
            formData.append('id', currentRecordId);
            formData.append('csrfmiddlewaretoken', getCookie('csrftoken'));
            
            fetch('/m34/', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                    'X-Requested-With': 'XMLHttpRequest',
                },
                body: formData
            })
            .then(response => {
                console.log('Delete response status:', response.status);
                console.log('Delete response content-type:', response.headers.get('content-type'));
                
                hideLoading();
                
                if (!response.ok) {
                    return response.text().then(text => {
                        console.error('Delete error response:', text);
                        throw new Error(`Server error: ${response.status}`);
                    });
                }
                
                // Check if response is JSON
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    return response.text().then(text => {
                        console.error('Expected JSON but got:', text);
                        throw new Error('Server returned HTML instead of JSON - check Django view');
                    });
                }
                
                return response.json();
            })
            .then(data => {
                console.log('Delete response data:', data);
                
                if (data.status === 'success') {
                    showMessage(data.message || '‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß', 'success');
                    
                    // Remove row from table
                    if (selectedRow) {
                        selectedRow.remove();
                        selectedRow = null;
                    }
                    
                    // Clear form and reset
                    clearForm();
                    setFormMode('view');
                    currentRecordId = null;
                    
                    // Optionally reload page to refresh data
                    setTimeout(() => {
                        window.location.reload();
                    }, 1000);
                    
                } else {
                    showMessage(data.message || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', 'error');
                }
            })
            .catch(error => {
                console.error('Delete error:', error);
                hideLoading();
                showMessage(`‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${error.message}`, 'error');
            });
        }

        // Enhanced getCookie function
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        // Also update the keyboard shortcut handler to ensure F4 works
        document.addEventListener('keydown', function(e) {
            // Prevent default browser behavior for function keys
            if (['F1', 'F2', 'F3', 'F4', 'F5', 'F6', 'F7', 'F8', 'F9', 'F10', 'F11', 'F12'].includes(e.key)) {
                e.preventDefault();
            }
            
            switch(e.key) {
                case 'F2':
                    new_Record();
                    break;
                case 'F3':
                    editRecord();
                    break;
                case 'F4':
                    deleteRecord();
                    break;
                case 'F5':
                    const searchInput = document.querySelector('input[name="search"]');
                    if (searchInput) searchInput.focus();
                    break;
                case 'F6':
                    printReport();
                    break;
                case 'F10':
                    saveRecord();
                    break;
                case 'Escape':
                    if (formMode === 'edit' || formMode === 'new') {
                        cancelEdit();
                    }
                    break;
            }
            
            // Ctrl+S for save
            if (e.ctrlKey && e.key === 's') {
                e.preventDefault();
                if (formMode === 'edit' || formMode === 'new') {
                    saveRecord();
                }
            }
        });

        // Print report
        function printReport() {
            window.print();
        }

        // Show loading
        function showLoading() {
            document.getElementById('loading').classList.remove('hidden');
        }

        // Hide loading
        function hideLoading() {
            document.getElementById('loading').classList.add('hidden');
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            if (e.key === 'F2') {
                e.preventDefault();
                new_Record();
            } else if (e.key === 'F3') {
                e.preventDefault();
                editRecord();
            } else if (e.key === 'F4') {
                e.preventDefault();
                deleteRecord();
            } else if (e.key === 'F5') {
                e.preventDefault();
                const searchInput = document.querySelector('input[name="search"]');
                if (searchInput) searchInput.focus();
            } else if (e.key === 'F6') {
                e.preventDefault();
                printReport();
            } else if (e.key === 'F7') {
                e.preventDefault();
                if (confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) {
                    window.close();
                }
            } else if (e.ctrlKey && e.key === 's') {
                e.preventDefault();
                if (formMode === 'edit' || formMode === 'new') {
                    saveRecord();
                }
            } else if (e.key === 'Escape') {
                e.preventDefault();
                if (formMode === 'edit' || formMode === 'new') {
                    cancelEdit();
                }
            } else if (e.key === 'F10') {
                e.preventDefault();
                saveRecord();
            }
        });

        // Auto-fill month and year when date changes
        document.getElementById('date').addEventListener('change', function() {
            const date = new Date(this.value);
            if (!isNaN(date.getTime())) {
                document.getElementById('month').value = String(date.getMonth() + 1).padStart(2, '0');
                document.getElementById('year').value = date.getFullYear();
                
                // Auto set due date to next month
                const dueDate = new Date(date);
                dueDate.setMonth(dueDate.getMonth() + 1);
                document.getElementById('duedate').value = dueDate.toISOString().split('T')[0];
            }
        });

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            setFormMode('view');
            
            // Select first row if exists
            const firstRow = document.querySelector('#dataTable tr[data-id]');
            if (firstRow) {
                const recordId = firstRow.getAttribute('data-id');
                selectRecord(firstRow, recordId);
            }
        });
    </script>
{% endblock %}